<!-- Purchase Order Builder (POB) -->

<apex:page standardController="Order__c" extensions="PobControllerExt">
	<apex:pageMessages />
	<apex:sectionHeader title="{!$Label.POB_Title}" subtitle="{!heading}"/>
	<apex:form >
		<apex:pageBlock title="{!$Label.POB_Title}" mode="edit">
		
			<!-- Buttons
			============================= -->
			<apex:pageBlockButtons >
				<apex:commandButton value="{!$Label.POB_Save}" action="{!save}"/>
				<apex:commandButton value="{!$Label.POB_Cancel}" action="{!cancel}"/>
			</apex:pageBlockButtons>
			
			<!-- Details
			============================= -->
			<apex:pageBlockSection title="Details" columns="2" id="details">
				<apex:inputField value="{!Order__c.Name}" required="true" />
				<apex:inputField value="{!Order__c.Status__c}" required="true" />
				<apex:pageBlockSectionItem >
					<apex:outputLabel value="{!$ObjectType.Order__c.fields.Budget__c.Label}"/>
					<apex:outputPanel >
						<!-- New orders or drafts -->
						<apex:inputField value="{!Order__c.Budget__c}" required="true" rendered="{!Order__c.id==null || Order__c.Status__c=='Draft'}"/>
						
						<!-- Open or closed orders -->
						<apex:outputText value="${0,number,###,###,##0}" rendered="{!Order__c.Status__c=='Open' || Order__c.Status__c=='Closed'}">
							<apex:param value="{!Order__c.Budget__c}"/>
						</apex:outputText>
					</apex:outputPanel>
				</apex:pageBlockSectionItem>
				<apex:inputField value="{!Order__c.Store__c}" required="true" />
			</apex:pageBlockSection>
			
			<!-- Summary
			============================= -->
			<apex:pageBlockSection title="{!$Label.POB_Summary}" columns="2" id="summary">
				<apex:pageBlockSectionItem >
					<apex:outputLabel value="{!$Label.POB_Units}"/>
					<apex:outputText value="{!units}"/>
				</apex:pageBlockSectionItem>
				<apex:pageBlockSectionItem >
					<apex:outputLabel value="{!$Label.POB_PricePerUnit}"/>
					<apex:outputText value="${0,number,###,###,##0.00}" rendered="{!pricePerUnit!=null}">
						<apex:param value="{!pricePerUnit}"/>
					</apex:outputText>
				</apex:pageBlockSectionItem>
			</apex:pageBlockSection>

			<!-- Filter & load indicator
			================================ -->			
			<apex:pageBlockSection title="Product Lots" columns="2">
				<apex:pageBlockSectionItem >
					<apex:outputLabel value="{!$Label.POB_Filter}" for="filter"/>
						<apex:actionRegion >
							<apex:actionFunction name="jsFilter" action="{!updateFilter}" reRender="table, pagination" status="filterStatus" />
				  			<apex:selectList size="1" value="{!categoryFilter}" onchange="jsFilter();">
								<apex:selectOptions value="{!filterValues}"/>
			      			</apex:selectList>
			      		</apex:actionRegion>
		      	</apex:pageBlockSectionItem>
		      	<apex:pageBlockSectionItem >
		      		<apex:actionStatus id="loadingStatus" startText="{!$Label.POB_Waiting}" />
		      		<apex:actionStatus id="filterStatus" startText="{!$Label.POB_Waiting_Filter}" />
		      	</apex:pageBlockSectionItem>
		   </apex:pageBlockSection>
		   
		   <!-- Product Lots Table
		   ============================= -->
		   <apex:pageBlockSection columns="1">
		   		<apex:outputPanel id="table">	
					<apex:pageBlockTable var="item" value="{!wrappers}" rendered="{!wrappers.size>0}">
						<apex:column headerValue="Units">
							<apex:inputText value="{!item.units}" required="true">
								<apex:actionSupport event="onchange" action="{!toggleSelection}" status="loadingStatus" immediate="true">
									<apex:param name="lot" assignTo="{!lotId}" value="{!item.product.id}" />
									<apex:param name="qty" assignTo="{!quantity}" value="{!item.units}"/>
								</apex:actionSupport>
							</apex:inputText>
						</apex:column>
						<apex:column headerValue="Product">{!item.product.Product__c}</apex:column>
						<apex:column headerValue="Lot Number">
							<apex:outputLink value="/{!item.product.id}">{!item.product.name}</apex:outputLink>
						</apex:column>
						<apex:column headerValue="Unit Price">
							<apex:outputText value="${0,number,###,###,##0.00}">
							  <apex:param value="{!item.product.Unit_Price__c}"/>
							</apex:outputText>
						</apex:column>
						<apex:column headerValue="Product Category">{!item.product.Product_Category__c}</apex:column>
						<apex:column headerValue="Remaining Units">
							<apex:outputText value="{0,number,###,###,##0}">
								<apex:param value="{!item.product.Remaining__c}"/>
							</apex:outputText>
						</apex:column>
					</apex:pageBlockTable>
					
					<apex:outputPanel rendered="{!wrappers.size==0}">
						<apex:outputText value="No products found"/>
					</apex:outputPanel>
					
					
				</apex:outputPanel>
			</apex:pageBlockSection>
			
		   <!-- Pagination
		   ============================= -->
			<apex:pageBlockSection id="pagination">
				<apex:panelGrid columns="5" rendered="{!wrappers.size>0}">
					<apex:commandButton action="{!firstPage}" value="{!$Label.POB_First}" disabled="{!prevDisabled}" immediate="true"/>
					<apex:commandButton action="{!prevPage}" value="{!$Label.POB_Prev}" disabled="{!prevDisabled}" immediate="true"/>
					<apex:outputText value="{!$Label.POB_Page}">
						<apex:param value="{!currentPage}"/>
		      			<apex:param value="{!numberOfPages}"/>
					</apex:outputText>
					<apex:commandButton action="{!nextPage}" value="{!$Label.POB_Next}" disabled="{!nextDisabled}" immediate="true"/>
					<apex:commandButton action="{!lastPage}" value="{!$Label.POB_Last}" disabled="{!nextDisabled}" immediate="true"/>
				</apex:panelGrid>
			</apex:pageBlockSection>
   		</apex:pageBlock>
   
	</apex:form>
</apex:page>